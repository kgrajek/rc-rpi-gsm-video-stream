<!DOCTYPE html>
<html>
<head>
	<title></title>
	<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
	<meta name="robots" content="no-index,no-follow"/>
	<meta name="author" content="kgrajek"/>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
	<style type="text/css">
		html, body {
			position: relative;
			background-color: #111;
			text-align: center;
			margin: 0 auto;
			font-family: Arial;
			max-width: 20cm;
		}

		#stdvideo {
			display: block;
			width: 100%;
			height: 40vh;
		}

		#console {
			width: 100%;
			height: 30vh;
			text-align: left;
			overflow: hidden;
			box-sizing: border-box;
			padding: 5px 0;
			font-family: courier;
		}

		#methods {
			width: 100%;
			height: 5vh;
		}

		.buttons {
			position: relative;
			width: 100%;
			margin-left: auto;
			margin-right: auto;
			height: 25vh;
		}
		.button {
			position: absolute;
			width: 25%;
			height: 50%;
			line-height: 50%;
			font-size: 100%;
			padding: 0;
			text-align: center;
		}

		.noselect {
			-webkit-touch-callout: none;
			-webkit-user-select: none;
			-khtml-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
		}
	</style>
</head>
<body>
	<canvas id="stdvideo" style=""></canvas>

	<select id="methods">
		<option selected>-</option>
		<option id="turn_on_fullscreen">turn-on-fullscreen</option>
		<option id="stop_stream">stop-stream</option>
		<option id="restart_stream">restart-stream</option>
		<option id="request_ship_status">request-ship-status</option>
	</select>

	<div id="console">
	</div>

	<div class="buttons noselect">
		<button id="dpad_l" class="button" style="top:0%; left:0%; ">◀</button>
		<button id="dpad_r" class="button" style="top:0%; left:25%;">▶</button>
		<button id="dpad_t" class="button" style="top:0%; left:50%;">▲</button>
		<button id="dpad_d" class="button" style="top:0%; left:75%;">▼</button>

		<button id="joyL_l" class="button" style="top:50%; left:0%;">◀</button>
		<button id="joyL_r" class="button" style="top:50%; left:25%;">▶</button>
		<button id="joyL_t" class="button" style="top:50%; left:50%;">▲</button>
		<button id="joyL_d" class="button" style="top:50%; left:75%;">▼</button>

		<!--
		<button id="x" class="button" style="top:66.6%; left:0%;">X</button>
		<button id="y" class="button" style="top:66.6%; left:25%;">Y</button>
		<button id="a" class="button" style="top:66.6%; left:50%;">A</button>
		<button id="b" class="button" style="top:66.6%; left:75%;">B</button>
		-->
	</div>

	<script type="text/javascript" src="libs/jsmpeg.min.js"></script>
	<script type="text/javascript" src="libs/console.js"></script>
	<script src="https://code.jquery.com/jquery-3.1.1.slim.min.js" integrity="sha256-/SIrNqv8h6QGKDuNoLGA4iret+kyesCkHGzVUUV0shc=" crossorigin="anonymous"></script>
	<script type="text/javascript">
		consoleapi$initialize(document.getElementById('console'));
	</script>
	<script type="text/javascript">
		var query = location.search.substr(1);
		var result = {};
		query.split('&').forEach(function(part) {
			var item = part.split("=");

			result[item[0]] = decodeURIComponent(item[1]);
		});
	</script>
	<script type="text/javascript">
		function fetchParam(value, dontAsk, missingText, defaultValue) {
			if (!value && !dontAsk) {
				return window.prompt(missingText, defaultValue);
			}

			return value;
		}
		function envIsOnHttps() {
			return location.protocol === 'https:' ? true : false;
		}
		function changeProtocol(protocol, url) {
			return url.replace(/^\w{2,5}:\/\//, protocol + '://');
		}
	</script>
	<script type="text/javascript">
		jQuery(document.body).click(function(event){
			var $this = jQuery(event.target);
			var clickedId = $this.attr('id');

			if (event.target.tagName && event.target.tagName.toLowerCase() === 'select') {
				clickedId = event.target.options[ event.target.selectedIndex ].id;
				event.target.options[0].selected = 1;
			}

			if (clickedId) {
				if (window['handle_click_' + clickedId]) {
					try {
						window['handle_click_' + clickedId]();
					}
					catch(ex) {
						console.error(ex);
					}
				}
			}
		});
	</script>
	<script type="text/javascript">
	</script>
	<script type="text/javascript">
		function handle_click_turn_on_fullscreen() {
			var element = document.body;
			var requestMethod = element.requestFullScreen || element.webkitRequestFullScreen || element.mozRequestFullScreen || element.msRequestFullScreen;
			if (requestMethod) {
				requestMethod.call(element);
			}
			else {
				console.warn('# fullscreen api not avaiable');
			}
		}
		function handle_click_stop_stream() {
			console.log('# requested: stop-stream');
			player.source.socket.send('! stop-stream');
		}
		function handle_click_restart_stream() {
			console.log('# requested:  restart-stream');
			player.source.socket.send('! restart-stream');
		}
		function handle_click_request_ship_status() {
			console.log('# requested:  request-ship-status');
			player.source.socket.send('! request-ship-status');
		}
	</script>
	<script type="text/javascript">
		var doRedirect = !result.server;
		var dontAsk = !doRedirect;
		var confServer = fetchParam(result.server, dontAsk, 'Adres serwera nasłuchującego', location.protocol + '//' + location.hostname);
		var confPort = fetchParam(result.port, dontAsk, 'Port', location.port);
	</script>
	<script type="text/javascript">
		if (doRedirect) {
			var redirUrl = document.location.origin + document.location.pathname + '?';
			var redirParams = {
				server: confServer,
				port: confPort
			};

			var redirQuery = "";
			for (var redirParam in redirParams) {
				if (redirQuery != "") {
					redirQuery += "&";
				}

				redirQuery += redirParam + "=" + encodeURIComponent(redirParams[redirParam]);
			}

			window.location = redirUrl + redirQuery;
		}
	</script>
	<script type="text/javascript">
		var canvas = document.getElementById('stdvideo');
		var isHttps = envIsOnHttps();
		var socketUrl = changeProtocol(isHttps ? 'wss' : 'ws', confServer);
		var url = socketUrl  + ( confPort ? ':' + confPort + '/' : '');
		var player = new JSMpeg.Player(url, { canvas:canvas, interceptor:function(data) {
			if (data === 'PADEHLO') {
				console.log('# ...PADEHLO received. Ready to go!');
			}
			else if (data.substring(0, 2) === '$ ') {
				console.log(data);
			}
			else {
				console.warn('# unknowm message:', data);
			}
		} });

		if (player && player.source.socket && player.source.socket) {
			var socketWait = setInterval(
				function() {
					console.log('# ...waiting to connect to: ' + confServer + ':' + confPort);
					if (player.source.socket.readyState === 1) {
						console.log('# ...connected');
						console.log('# ...sending EHLOPAD');
						player.source.socket.send('EHLOPAD'); // TODO async
						clearInterval(socketWait);
					}
				},
				1000
			);
		}
		else {
			console.error('# connection/player initialization failed');
		}
	</script>
	<script type="text/javascript">
		window.addEventListener("gamepadconnected", function(e) {
			console.log("gamepad connected");
		});

		window.addEventListener("gamepaddisconnected", function(e) {
			console.log("gamepad disconnected");
		});

		function mapGamepadStateToKeys(gamepad) {
			return {
				// TODO this map is probably specific to my pad only
				dpad_l: gamepad.axes[3] > 0.1,
				dpad_r: gamepad.axes[4] > 0.1,
				dpad_t: gamepad.axes[9] < -0.9,
				dpad_d: gamepad.axes[9] < 0.5 && gamepad.axes[9] > 0.1,

				joyL_l: gamepad.axes[0] < -0.5,  // -1 left; 1 right
				joyL_r: gamepad.axes[0] > 0.5,
				joyL_t: gamepad.axes[1] < -0.5, // -1 up; 1 down
				joyL_d: gamepad.axes[1] > 0.5,

				joyR_l: gamepad.axes[2] < -0.5, // -1 left; 1 right
				joyR_r: gamepad.axes[2] > 0.5,
				joyR_t: gamepad.axes[5] < -0.5, // -1 up; 1 down
				joyR_d: gamepad.axes[5] > 0.5,

				x: gamepad.buttons[3].value,
				y: gamepad.buttons[4].value,
				a: gamepad.buttons[0].value,
				b: gamepad.buttons[1].value,
				select: gamepad.buttons[10].value,
				start: gamepad.buttons[11].value
			};
		}

		function mapGamepadKeysToCommands(x) {
			var commands = [];

			for (var key in x) {
				if (x[key]) {
					commands.push(key);
				}
			}

			return commands;
		}
	</script>
	<script type="text/javascript">
		var vpad = {};
		jQuery(document).ready(function(){
			jQuery('.button').each(function(){
				var $this = jQuery(this);
				var id = $this.attr('id');

				$this.on('mousedown touchstart', function() {
					vpad[id] = 1;
				});

				$this.on('mouseleave mouseup touchend ', function() {
					vpad[id] = 0;
				});
			});
		});
	</script>
	<script type="text/javascript">
		// connect command feeder
		/*var ctrlWsUrl = 'ws://' + confServer + ':' + confPort + '/';
		console.log(ctrlWsUrl);
		setTimeout(function() {
			var ctrlWs = new WebSocket(ctrlWsUrl);
			ctrlWs.onopen = function open() {
				ctrlWs.send('EHLOPAD');
			};
			ctrlWs.onmessage = function (event) {
				console.log(event.data);
			}

		}, 2000)*/
	</script>
	<script type="text/javascript">
		// integrate pad with websocket

		if (navigator.getGamepads) {
			setInterval(function() {
				var keys = {};

				var gamepad = navigator.getGamepads()[0];
				if (gamepad) {
					keys = mapGamepadStateToKeys(gamepad);
				}

				for (var key in vpad) {
					if (vpad[key]) {
						keys[key] = vpad[key];
					}
				}

				var commands = mapGamepadKeysToCommands(keys);
				if (commands.length) {
					// console.log(commands);
				}

				for (var i=0; i<commands.length; i++) {
					player.source.socket.send('! ' + commands[i]);
				}
			}, 100);
		}
		else {
			console.warn('# gamepad api not accessible');
		}
	</script>
	<script type="text/javascript">
		console.log('# aplication initialized');
	</script>
</body>
</html>
